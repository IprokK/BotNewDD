<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: system-ui; background: var(--tg-theme-bg-color, #1a1a1a); color: var(--tg-theme-text-color, #fff); margin: 0; padding: 24px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        #status { text-align: center; max-width: 320px; line-height: 1.6; }
        .err { color: #f85149; }
        .hint { color: var(--tg-theme-hint-color, #8b949e); margin-top: 16px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div id="status">Проверка...</div>
    <script>
    (function() {
        const initData = typeof Telegram !== 'undefined' && Telegram.WebApp ? Telegram.WebApp.initData : '';
        const params = new URLSearchParams(location.search);
        const eventId = parseInt(params.get('event_id') || params.get('event') || '1');
        if (!initData) {
            document.getElementById('status').innerHTML = 
                '<p>initData недоступен (часто при ngrok).</p>' +
                '<p class="hint">Введите ваш Telegram ID для входа:</p>' +
                '<form id="fallback" style="margin-top:12px;">' +
                '<input type="number" name="tg_id" placeholder="Ваш Telegram ID" required style="width:100%;padding:12px;margin-bottom:8px;border-radius:8px;background:#21262d;color:#fff;border:1px solid #30363d;">' +
                '<button type="submit" style="width:100%;padding:12px;background:#58a6ff;color:#fff;border:none;border-radius:8px;">Войти</button>' +
                '</form>' +
                '<p class="hint" style="margin-top:12px;">Узнать ID: напишите @userinfobot в Telegram</p>';
            document.getElementById('fallback').addEventListener('submit', function(e) {
                e.preventDefault();
                const tgId = e.target.tg_id.value;
                window.location.href = '/dev/login/' + tgId + '/' + eventId + '?role=PLAYER';
            });
            return;
        }
        fetch('/auth/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ init_data: initData, event_id: eventId })
        }).then(async r => {
            const data = await r.json().catch(() => ({}));
            if (r.ok && (data.token || data.redirect)) {
                window.location.href = data.redirect || '/player';
            } else {
                const err = data.error || (Array.isArray(data.detail) ? data.detail[0]?.msg : data.detail) || r.status;
                let msg = 'Ошибка: ' + err;
                if (err && err.includes('Not registered')) {
                    msg = 'Вы ещё не зарегистрированы на квест.<span class="hint">Напишите боту «Регистрация» или нажмите кнопку в меню, затем откройте игру снова.</span>';
                }
                document.getElementById('status').innerHTML = msg;
                document.getElementById('status').className = 'err';
            }
        }).catch(e => { document.getElementById('status').innerHTML = 'Ошибка: ' + e.message; document.getElementById('status').className = 'err'; });
    })();
    </script>
</body>
</html>
