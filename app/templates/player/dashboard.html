{% extends "player/base_app.html" %}
{% block head %}
<style>
    .route-list { display: flex; flex-direction: column; gap: 0; }
    .route-item { display: flex; gap: 14px; padding: 14px 16px; background: var(--surface); border-radius: var(--radius); margin-bottom: 10px; box-shadow: var(--shadow); border-left: 4px solid var(--border); align-items: flex-start; }
    .route-item.route-done { border-left-color: var(--success); opacity: 0.85; }
    .route-item.route-current { border-left-color: var(--accent); background: linear-gradient(135deg, rgba(196,92,38,0.08), var(--surface)); }
    .route-num { width: 28px; height: 28px; min-width: 28px; border-radius: 50%; background: var(--border); color: var(--muted); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; }
    .route-done .route-num { background: var(--success); color: #fff; }
    .route-current .route-num { background: var(--accent); color: #fff; }
    .route-content { flex: 1; min-width: 0; }
    .route-name { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
    .route-addr { font-size: 0.85rem; color: var(--muted); margin-top: 4px; }
    .route-hint { font-size: 0.8rem; color: var(--accent); margin-top: 6px; }
    .route-mask { letter-spacing: 0.2em; color: var(--muted); }
</style>
{% endblock %}
{% block team_name %}{{ team.name if team else '‚Äî' }}{% endblock %}
{% block player_role %}{{ player_role }}{% endblock %}
{% block points %}{{ team.score_total if team else 0 }}{% endblock %}

{% block sticky_banner %}
{% if team and station and team.current_state in ('assigned', 'in_visit') %}
<div class="sticky-banner" onclick="document.querySelector('[data-screen=status]').click()">
    üìç –í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Å—Ç–∞–Ω—Ü–∏—è: {{ station.name }} ‚Äî –Ω–∞–∂–º–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
</div>
{% endif %}
{% endblock %}

{% block content %}
<!-- Screen 1: –ü—Ä–µ–¥–º–µ—Ç—ã -->
<div class="screen active" id="screen-items">
    <h2 style="margin:0 0 16px;font-size:1.25rem;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
    <div class="item-grid" id="inventory-grid">
        <div class="item-card" onclick="openItem('phone')">
            <div class="item-icon">üì±</div>
            <div class="item-name">–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω</div>
            <div class="item-desc">–ß–∞—Ç—ã, –Ω–∞–ø–∞—Ä–Ω–∏–∫, —Å–∫–∞–Ω–µ—Ä</div>
        </div>
        {% for item_key in inventory %}
        {% if item_key == 'diary' %}
        <div class="item-card" onclick="openItem('diary')">
            <div class="item-icon">üìñ</div>
            <div class="item-name">–õ–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫</div>
            <div class="item-desc">–°—Ç—Ä–∞–Ω–∏—Ü—ã, –∑–∞–º–µ—Ç–∫–∏</div>
        </div>
        {% elif item_key == 'witch' %}
        <div class="item-card" onclick="openItem('witch')">
            <div class="item-icon">üìï</div>
            <div class="item-name">–ú–µ—Ç–æ–¥–∏—á–∫–∞ –≤–µ–¥—å–º—ã</div>
            <div class="item-desc">–†–µ—Ü–µ–ø—Ç—ã, –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è</div>
        </div>
        {% elif item_key == 'other_phone' %}
        <div class="item-card" onclick="openItem('other_phone')">
            <div class="item-icon">üì±</div>
            <div class="item-name">–ß—É–∂–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω</div>
            <div class="item-desc">–ê—Ä—Ö–∏–≤ –ø–µ—Ä–µ–ø–∏—Å–æ–∫</div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Screen 2: –ö–≤–µ—Å—Ç -->
<div class="screen" id="screen-quest">
    <h2 style="margin:0 0 16px;font-size:1.25rem;">–ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç</h2>
    {% if all_stations %}
    <div class="route-list">
        {% for s in all_stations %}
        {% set is_revealed = s.id in visited_station_ids or s.id == current_station_id %}
        <div class="route-item {% if s.id in visited_station_ids %}route-done{% endif %} {% if s.id == current_station_id %}route-current{% endif %} {% if not is_revealed %}route-masked{% endif %}">
            <div class="route-num">{{ loop.index }}</div>
            <div class="route-content">
                <div class="route-name">
                    {% if s.id in visited_station_ids %}‚úÖ{% elif s.id == current_station_id %}üìç{% else %}‚óã{% endif %}
                    {% if is_revealed %}{{ s.name }}{% else %}<span class="route-mask">???</span>{% endif %}
                </div>
                {% if is_revealed and (s.config or {}).get('address') %}
                <div class="route-addr">{{ (s.config or {}).get('address') }}</div>
                {% endif %}
                {% if s.id == current_station_id and team and team.current_state in ('assigned', 'in_visit') %}
                <div class="route-hint">–ü–æ–∫–∞–∂–∏—Ç–µ QR –≤–µ–¥—É—â–µ–º—É –ø—Ä–∏ –ø—Ä–∏–±—ã—Ç–∏–∏</div>
                {% endif %}
                {% if not is_revealed %}
                <div class="route-addr" style="font-style:italic;">–°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color:var(--muted);">–°—Ç–∞–Ω—Ü–∏–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
    {% endif %}
    <h3 style="margin:24px 0 12px;font-size:0.95rem;color:var(--muted);">–£–ª–∏–∫–∏ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h3>
    {% for block, delivery in deliveries %}
    <div style="background:var(--surface);border-radius:var(--radius);padding:16px;margin-bottom:8px;box-shadow:var(--shadow);border-left:4px solid var(--accent);">
        <strong>{{ block.key }}</strong>
        <p style="margin:8px 0 0;font-size:0.9rem;">{{ block.payload.get('text', '') | default('', true) }}</p>
    </div>
    {% else %}
    <p style="color:var(--muted);">–ü–æ–∫–∞ –Ω–µ—Ç —É–ª–∏–∫</p>
    {% endfor %}
</div>

<!-- Screen 3: –ß–∞—Ç—ã (Telegram-style) -->
<div class="screen" id="screen-chats">
    <h2 style="margin:0 0 16px;font-size:1.25rem;">–ß–∞—Ç—ã</h2>
    {% if teammate_info %}
    <a href="#" onclick="openItem('phone'); document.querySelector('.chat-item[data-open=partner]').click(); return false;" style="display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border-radius:var(--radius);margin-bottom:10px;box-shadow:var(--shadow);text-decoration:none;color:inherit;">
        <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;font-weight:600;flex-shrink:0;">{{ teammate_info.name[:1]|upper }}</div>
        <div style="flex:1;min-width:0;">
            <div style="font-weight:600;font-size:1rem;">{{ teammate_info.name }}</div>
            <div style="font-size:0.85rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{% if teammate_info.preview %}{{ teammate_info.preview }}{% else %}–ß–∞—Ç —Å –Ω–∞–ø–∞—Ä–Ω–∏–∫–æ–º{% endif %}</div>
        </div>
        <div style="font-size:0.75rem;color:var(--muted);flex-shrink:0;">{% if teammate_info.time %}{{ teammate_info.time.strftime('%H:%M') }}{% endif %}</div>
    </a>
    {% endif %}
    {% for t in threads %}
    <a href="/player/dialogues/{{ t.key }}" style="display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border-radius:var(--radius);margin-bottom:10px;box-shadow:var(--shadow);text-decoration:none;color:inherit;">
        <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;font-weight:600;flex-shrink:0;overflow:hidden;">{% if t.avatar_url %}<img src="{{ t.avatar_url }}" alt="" style="width:100%;height:100%;object-fit:cover;">{% else %}{{ (t.title or t.key)[:1]|upper }}{% endif %}</div>
        <div style="flex:1;min-width:0;">
            <div style="font-weight:600;font-size:1rem;">{{ t.title or t.key }}</div>
            <div style="font-size:0.85rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{% if t.preview %}{{ t.preview }}{% else %}–î–∏–∞–ª–æ–≥{% endif %}</div>
        </div>
        <div style="font-size:0.75rem;color:var(--muted);flex-shrink:0;">‚Ä∫</div>
    </a>
    {% else %}
    {% if not teammate_info %}<p style="color:var(--muted);text-align:center;padding:24px;">–ù–µ—Ç —á–∞—Ç–æ–≤</p>{% endif %}
    {% endfor %}
</div>

<!-- Screen 4: –°—Ç–∞—Ç—É—Å -->
<div class="screen" id="screen-status">
    <h2 style="margin:0 0 16px;font-size:1.25rem;">–°—Ç–∞—Ç—É—Å</h2>
    <div style="background:var(--surface);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);margin-bottom:16px;">
        <p style="margin:0 0 12px;"><strong>–†–µ–∂–∏–º:</strong> 
            {% if team.current_state == 'free_roam' %}üü¢ –°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
            {% elif team.current_state == 'assigned' %}üîµ –ù–∞–∑–Ω–∞—á–µ–Ω–∞ —Å—Ç–∞–Ω—Ü–∏—è
            {% elif team.current_state == 'in_visit' %}üü° –ù–∞ —Å—Ç–∞–Ω—Ü–∏–∏
            {% elif team.current_state == 'finished' %}‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω
            {% else %}{{ team.current_state }}{% endif %}
        </p>
        {% if station %}
        <p style="margin:0 0 12px;"><strong>–ö—É–¥–∞ –∏–¥—Ç–∏:</strong> {{ station.name }}</p>
        <p style="margin:0;font-size:0.9rem;color:var(--muted);">–ü–æ–∫–∞–∂–∏—Ç–µ QR –≤–µ–¥—É—â–µ–º—É –ø—Ä–∏ –ø—Ä–∏–±—ã—Ç–∏–∏</p>
        {% else %}
        <p style="margin:0;color:var(--muted);">–û–∂–∏–¥–∞–π—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏</p>
        {% endif %}
    </div>
    <button class="qr-btn" style="width:100%;padding:14px;border-radius:var(--radius);" onclick="document.getElementById('qr-open').click()">
        üì± –ü–æ–∫–∞–∑–∞—Ç—å QR –∫–æ–º–∞–Ω–¥—ã
    </button>
    {% if pending_ratings %}
    <div style="margin-top:20px;">
        <h3 style="font-size:0.95rem;">‚≠ê –û—Ü–µ–Ω–∏—Ç—å —Å—Ç–∞–Ω—Ü–∏–∏</h3>
        {% for visit, st in pending_ratings %}
        <a href="/player/rating?visit_id={{ visit.id }}" style="display:block;padding:12px;background:var(--surface);border-radius:var(--radius-sm);margin-top:8px;text-decoration:none;color:var(--accent);">–û—Ü–µ–Ω–∏—Ç—å ¬´{{ st.name }}¬ª</a>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Item overlays (phone, diary, etc.) - shown when item tapped -->
<div id="item-phone" class="screen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:200;display:none;overflow:hidden;flex-direction:column;flex-wrap:nowrap;">
    <div class="phone-header" style="padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;">
        <button onclick="closeItem()" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:50%;cursor:pointer;font-size:1.2rem;color:var(--accent);">‚Üê</button>
        <h2 style="margin:0;font-size:1.1rem;">–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω</h2>
    </div>
    <!-- Chat list (Telegram style) -->
    <div id="phone-chat-list" class="phone-view" style="flex:1;overflow-y:auto;">
        <div class="chat-list" style="padding:0;">
            {% if teammate_info %}
            <a href="#" class="chat-item" data-open="partner" style="display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border-bottom:1px solid var(--border);text-decoration:none;color:inherit;">
                <div class="chat-avatar" style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;font-weight:600;flex-shrink:0;">{{ teammate_info.name[:1]|upper }}</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:1rem;">{{ teammate_info.name }}</div>
                    <div style="font-size:0.85rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{% if teammate_info.preview %}{{ teammate_info.preview }}{% else %}–ß–∞—Ç —Å –Ω–∞–ø–∞—Ä–Ω–∏–∫–æ–º{% endif %}</div>
                </div>
                <div style="font-size:0.75rem;color:var(--muted);flex-shrink:0;">{% if teammate_info.time %}{{ teammate_info.time.strftime('%H:%M') }}{% endif %}</div>
            </a>
            {% endif %}
            {% for t in threads %}
            <a href="/player/dialogues/{{ t.key }}" class="chat-item" style="display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border-bottom:1px solid var(--border);text-decoration:none;color:inherit;">
                <div class="chat-avatar" style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;font-weight:600;flex-shrink:0;overflow:hidden;">{% if t.avatar_url %}<img src="{{ t.avatar_url }}" alt="" style="width:100%;height:100%;object-fit:cover;">{% else %}{{ (t.title or t.key)[:1]|upper }}{% endif %}</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:1rem;">{{ t.title or t.key }}</div>
                    <div style="font-size:0.85rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{% if t.preview %}{{ t.preview }}{% else %}–î–∏–∞–ª–æ–≥{% endif %}</div>
                </div>
                <div style="font-size:0.75rem;color:var(--muted);flex-shrink:0;">‚Ä∫</div>
            </a>
            {% endfor %}
            <a href="#" class="chat-item" data-open="scanner" style="display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border-bottom:1px solid var(--border);text-decoration:none;color:inherit;">
                <div class="chat-avatar" style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#4a7c59,#2d5a3d);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;flex-shrink:0;">üì∑</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:1rem;">–°–∫–∞–Ω–µ—Ä</div>
                    <div style="font-size:0.85rem;color:var(--muted);">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR –∏ —à—Ç—Ä–∏—Ö–∫–æ–¥—ã</div>
                </div>
                <div style="font-size:1rem;color:var(--muted);flex-shrink:0;">‚Ä∫</div>
            </a>
            {% if not teammate_info and not threads %}
            <div style="padding:24px;text-align:center;color:var(--muted);">–ù–µ—Ç —á–∞—Ç–æ–≤</div>
            {% endif %}
        </div>
    </div>
    <!-- Team chat view (inline) -->
    <div id="phone-partner" class="phone-view" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
        <div style="padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;">
            <button onclick="phoneShowList()" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:50%;cursor:pointer;font-size:1.2rem;color:var(--accent);">‚Üê</button>
            <h2 style="margin:0;font-size:1rem;">{{ teammate_info.name if teammate_info else '–ù–∞–ø–∞—Ä–Ω–∏–∫' }}</h2>
        </div>
        <div id="team-chat-container" style="flex:1;overflow-y:auto;padding:16px;" hx-get="/player/team-chat" hx-trigger="load, every 5s" hx-swap="innerHTML">
            <p style="color:var(--muted);">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
        </div>
    </div>
    <!-- Scanner view (inline) -->
    <div id="phone-scanner" class="phone-view" style="display:none;flex:1;flex-direction:column;overflow-y:auto;">
        <div style="padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;">
            <button onclick="phoneShowList()" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:50%;cursor:pointer;font-size:1.2rem;color:var(--accent);">‚Üê</button>
            <h2 style="margin:0;font-size:1rem;">–°–∫–∞–Ω–µ—Ä</h2>
        </div>
        <div style="padding:16px;">
            <button onclick="startScanner()" style="width:100%;padding:16px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius);cursor:pointer;font-size:1rem;">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR / —à—Ç—Ä–∏—Ö–∫–æ–¥</button>
            <div id="scan-result" style="margin-top:16px;"></div>
        </div>
    </div>
</div>
<div id="item-diary" class="screen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--surface);z-index:200;display:none;flex-direction:column;overflow:hidden;">
    <div style="padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:12px;">
        <button onclick="closeItem()" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:50%;cursor:pointer;font-size:1.2rem;color:var(--accent);">‚Üê</button>
        <div>
            <h2 style="margin:0;font-size:1.1rem;">–õ–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫</h2>
            <p style="margin:2px 0 0;font-size:0.85rem;color:var(--muted);">{{ diary_subtitle | default('–ó–∞–ø–∏—Å–∏') }}</p>
        </div>
    </div>
    <div style="flex:1;overflow-y:auto;padding:16px;-webkit-overflow-scrolling:touch;">
        <div class="diary-document" style="max-width:600px;margin:0 auto;line-height:1.65;font-size:0.95rem;">{{ diary_content | safe }}</div>
    </div>
</div>
<div id="item-witch" class="screen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--surface);z-index:200;display:none;overflow-y:auto;">
    <div style="padding:16px;padding-top:50px;">
        <button onclick="closeItem()" style="margin-bottom:16px;padding:8px 16px;background:var(--border);border:none;border-radius:var(--radius-sm);cursor:pointer;">‚Üê –ù–∞–∑–∞–¥</button>
        <h2 style="margin:0 0 16px;">üìï –ú–µ—Ç–æ–¥–∏—á–∫–∞ –≤–µ–¥—å–º—ã</h2>
        <p style="color:var(--muted);">–†–µ—Ü–µ–ø—Ç—ã –∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è –æ—Ç–∫—Ä–æ—é—Ç—Å—è –Ω–∞ —Å—Ç–∞–Ω—Ü–∏—è—Ö</p>
    </div>
</div>
<div id="item-other_phone" class="screen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--surface);z-index:200;display:none;overflow-y:auto;">
    <div style="padding:16px;padding-top:50px;">
        <button onclick="closeItem()" style="margin-bottom:16px;padding:8px 16px;background:var(--border);border:none;border-radius:var(--radius-sm);cursor:pointer;">‚Üê –ù–∞–∑–∞–¥</button>
        <h2 style="margin:0 0 16px;">üì± –ß—É–∂–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω</h2>
        <p style="color:var(--muted);">–ê—Ä—Ö–∏–≤ –ø–µ—Ä–µ–ø–∏—Å–æ–∫ ‚Äî —á–∏—Ç–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ</p>
        {% for t in threads %}
        <a href="/player/dialogues/{{ t.key }}" style="display:block;padding:14px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:8px;text-decoration:none;color:inherit;">{{ t.title or t.key }}</a>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        if (Telegram.WebApp.MainButton) Telegram.WebApp.MainButton.hide();
    }
    const qrToken = '{{ team.qr_token or "" }}';
    const qrModal = document.getElementById('qr-modal');
    const qrOpen = document.getElementById('qr-open');
    const qrClose = document.getElementById('qr-close');
    qrOpen.onclick = () => {
        if (qrToken && typeof QRCode !== 'undefined') {
            document.getElementById('qr-code').innerHTML = '';
            new QRCode(document.getElementById('qr-code'), { text: qrToken, width: 200, height: 200 });
            document.getElementById('qr-team-label').textContent = '{{ team.name if team else "" }}';
            qrModal.classList.add('show');
        }
    };
    qrClose.onclick = () => qrModal.classList.remove('show');
    qrModal.onclick = (e) => { if (e.target === qrModal) qrModal.classList.remove('show'); };
    document.querySelectorAll('.nav-item').forEach(el => {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById('screen-' + this.dataset.screen);
            if (screen) screen.classList.add('active');
        });
    });
    window.phoneShowList = function() {
        document.getElementById('phone-chat-list').style.display = 'block';
        document.getElementById('phone-partner').style.display = 'none';
        document.getElementById('phone-scanner').style.display = 'none';
    };
    document.querySelectorAll('.chat-item[data-open]').forEach(el => {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            const view = this.dataset.open;
            document.getElementById('phone-chat-list').style.display = 'none';
            document.getElementById('phone-partner').style.display = view === 'partner' ? 'flex' : 'none';
            document.getElementById('phone-scanner').style.display = view === 'scanner' ? 'flex' : 'none';
            if (view === 'partner' && typeof htmx !== 'undefined') {
                htmx.ajax('get', '/player/team-chat', {target: '#team-chat-container', swap: 'innerHTML'});
            }
            if (view === 'scanner') setTimeout(() => startScanner(), 100);
        });
    });
    window.openItem = function(id) {
        const el = document.getElementById('item-' + id);
        el.style.display = (id === 'phone') ? 'flex' : 'block';
    };
    let playerQrScanner = null;
    window.closeItem = function() {
        if (playerQrScanner && playerQrScanner.isScanning) playerQrScanner.stop();
        playerQrScanner = null;
        document.querySelectorAll('[id^="item-"]').forEach(el => { if (el.id.startsWith('item-')) el.style.display = 'none'; });
    };
    window.startScanner = async function() {
        const resultDiv = document.getElementById('scan-result');
        if (typeof Html5Qrcode === 'undefined') {
            resultDiv.innerHTML = '<p>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é:</p><input type="text" id="manual-scan-code" placeholder="–ö–æ–¥ –∏–∑ QR" style="padding:10px;width:100%;margin-top:8px;"><button onclick="onScanResult(document.getElementById(\'manual-scan-code\').value)" style="margin-top:8px;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>';
            return;
        }
        resultDiv.innerHTML = '<p>–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</p>';
        try {
            resultDiv.innerHTML = '<div id="player-qr-reader"></div>';
            playerQrScanner = new Html5Qrcode('player-qr-reader');
            await playerQrScanner.start(
                { facingMode: 'environment' },
                { fps: 10, qrbox: { width: 220, height: 220 } },
                (decoded) => {
                    if (playerQrScanner && playerQrScanner.isScanning) playerQrScanner.stop();
                    playerQrScanner = null;
                    onScanResult(decoded);
                },
                () => {}
            );
        } catch (e) {
            resultDiv.innerHTML = '<p>–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è). –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é:</p><input type="text" id="manual-scan-code" placeholder="–ö–æ–¥ –∏–∑ QR" style="padding:10px;width:100%;margin-top:8px;"><button onclick="onScanResult(document.getElementById(\'manual-scan-code\').value)" style="margin-top:8px;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>';
        }
    };
    window.onScanResult = async function(decoded) {
        const resultDiv = document.getElementById('scan-result');
        const code = (decoded || '').trim();
        resultDiv.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞‚Ä¶</p>';
        try {
            const fd = new FormData();
            fd.append('code', code);
            const r = await fetch('/player/scan', { method: 'POST', body: fd });
            const data = await r.json();
            if (data.ok) {
                const itemNames = { diary: '–õ–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫', witch: '–ú–µ—Ç–æ–¥–∏—á–∫–∞ –≤–µ–¥—å–º—ã', other_phone: '–ß—É–∂–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω' };
                const name = itemNames[data.item_key] || data.item_key;
                resultDiv.innerHTML = '<div style="padding:16px;background:var(--success,#4a7c59);color:#fff;border-radius:var(--radius);margin-bottom:12px;">‚úÖ –ü–æ–ª—É—á–µ–Ω–æ: ' + name + '</div><p style="color:var(--muted);">–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äî –ø—Ä–µ–¥–º–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ</p><button onclick="window.location.reload()" style="width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius);cursor:pointer;">–û–±–Ω–æ–≤–∏—Ç—å</button>';
            } else {
                resultDiv.innerHTML = '<div style="padding:16px;background:#8b2635;color:#fff;border-radius:var(--radius);margin-bottom:12px;">‚ùå ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–¥') + '</div><button onclick="startScanner()" style="width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius);cursor:pointer;">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë</button>';
            }
        } catch (e) {
            resultDiv.innerHTML = '<div style="padding:16px;background:#8b2635;color:#fff;border-radius:var(--radius);">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div><button onclick="startScanner()" style="margin-top:12px;width:100%;padding:12px;">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë</button>';
        }
    };
})();
</script>
{% endblock %}
