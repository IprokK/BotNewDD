{% extends "player/base_app.html" %}
{% block team_name %}{{ team.name if team else '—' }}{% endblock %}
{% block player_role %}{{ player_role }}{% endblock %}
{% block points %}{{ team.score_total if team else 0 }}{% endblock %}
{% block content %}
<style>
    .chat-header { padding: 12px 16px; background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
    .chat-messages { padding: 16px; min-height: 300px; }
    .msg-bubble { max-width: 85%; margin-bottom: 12px; padding: 12px 16px; border-radius: 16px; font-size: 0.95rem; line-height: 1.4; }
    .msg-bubble.in { background: var(--border); margin-right: auto; border-bottom-left-radius: 4px; }
    .msg-bubble.out { background: var(--accent); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
    .msg-bubble .sender { font-size: 0.75rem; color: var(--muted); margin-bottom: 4px; }
    .msg-bubble.out .sender { color: rgba(255,255,255,0.8); }
    .quick-replies { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px 16px; background: var(--surface); border-top: 1px solid var(--border); }
    .quick-reply { padding: 10px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 20px; font-size: 0.9rem; cursor: pointer; font-family: inherit; }
    .quick-reply:hover { background: var(--border); }
    .back-link { display: inline-block; padding: 8px 0; color: var(--accent); text-decoration: none; font-size: 0.9rem; }
</style>
<div class="chat-header">
    <a href="/player" class="back-link">← Назад</a>
    <h2 style="margin: 8px 0 0; font-size: 1.1rem;">{{ thread.title or thread.key }}</h2>
</div>
<div class="chat-messages" id="dialogue-messages">
    {% for m in messages %}
    <div class="msg-bubble in">
        {% if m.payload.get('character') %}<div class="sender">{{ m.payload.character }}</div>{% endif %}
        {{ m.payload.get('text', m.payload) }}
    </div>
    {% endfor %}
</div>
{% if thread.type == 'INTERACTIVE' %}
<div class="quick-replies" id="dialogue-quick-replies">
    {% if pending_reply %}
    {% set opts = pending_reply.payload.get('reply_options') or [] %}
    {% if opts %}
    <p style="width:100%;margin:0 0 8px;font-size:0.85rem;color:var(--muted);">Выберите ответ:</p>
    {% for o in opts %}
    <form hx-post="/player/dialogues/{{ thread.key }}/reply" hx-target="#dialogue-messages" hx-swap="beforeend" hx-on::after-request="if(event.detail.successful) document.getElementById('dialogue-quick-replies').innerHTML='';" style="display:contents;">
        <input type="hidden" name="message" value="{{ o.text }}">
        <input type="hidden" name="message_id" value="{{ pending_reply.id }}">
        <input type="hidden" name="next_message_id" value="{{ o.next_message_id or '' }}">
        <input type="hidden" name="delay_seconds" value="{{ o.get('delay_seconds', 0) or 0 }}">
        <button type="submit" class="quick-reply">{{ o.text }}</button>
    </form>
    {% endfor %}
    {% else %}
    <form hx-post="/player/dialogues/{{ thread.key }}/reply" hx-target="#dialogue-messages" hx-swap="beforeend" style="width:100%;display:flex;flex-wrap:wrap;gap:8px;">
        <input type="text" name="message" placeholder="Свой ответ..." style="flex:1;min-width:120px;padding:12px;border-radius:20px;border:1px solid var(--border);">
        <button type="submit" class="quick-reply" style="background:var(--accent);color:#fff;border-color:var(--accent);">Отправить</button>
    </form>
    {% endif %}
    {% else %}
    <p style="font-size:0.9rem;color:var(--muted);">Диалог завершён</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}
