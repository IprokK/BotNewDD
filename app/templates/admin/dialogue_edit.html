{% extends "admin/base.html" %}
{% block title %}{{ thread.title or thread.key }}{% endblock %}
{% block content %}
<style>
    .dialog-editor { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
    @media (max-width: 1000px) { .dialog-editor { grid-template-columns: 1fr; } }
    .msg-item { padding: 14px 16px; background: var(--admin-bg); border-radius: 8px; margin-bottom: 8px; cursor: grab; border-left: 4px solid var(--admin-accent); }
    .msg-item .meta { font-size: 0.8rem; color: var(--admin-muted); margin-bottom: 6px; }
    .msg-item .text { margin: 0; }
    .msg-item .edit-btn { float: right; padding: 4px 8px; font-size: 0.8rem; }
    .form-grid { display: grid; gap: 12px; }
    .form-grid label { display: block; font-size: 0.85rem; color: var(--admin-muted); margin-bottom: 4px; }
    .reply-opts { border: 1px dashed var(--admin-border); padding: 12px; border-radius: 6px; margin-top: 8px; }
    .reply-opts-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .reply-opts-row input { flex: 1; }
</style>

<p><a href="/admin/dialogues" style="color:var(--admin-accent);">‚Üê –ö —Å–ø–∏—Å–∫—É –¥–∏–∞–ª–æ–≥–æ–≤</a> ¬∑ <a href="/admin/dialogues/{{ thread.id }}/graph" style="color:var(--admin-accent);">üìä –†–µ–¥–∞–∫—Ç–æ—Ä –≥—Ä–∞—Ñ–∞</a></p>
<h2>{{ thread.title or thread.key }}</h2>
<p style="color:var(--admin-muted);">–¢–∏–ø: {{ thread.type }} | –ö–ª—é—á: {{ thread.key }}</p>
<div class="card" style="margin-bottom:20px;">
    <h3>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (–∞–≤–∞—Ç–∞—Ä–∫–∏)</h3>
    <p style="font-size:0.9rem;color:var(--admin-muted);">–§–æ—Ä–º–∞—Ç: @–Ω–∏–∫ ‚Äî URL –∞–≤–∞—Ç–∞—Ä–∫–∏. –ü—Ä–∏–º–µ—Ä: @anna ‚Äî https://....</p>
    <form method="post" action="/admin/dialogues/{{ thread.id }}/characters" style="display:flex;flex-direction:column;gap:12px;">
        <textarea name="characters_json" rows="6" placeholder='{"@anna": {"avatar": "https://..."}, "@bot": {"avatar": ""}}' style="font-family:monospace;">{{ characters_json }}</textarea>
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</button>
    </form>
</div>

<div class="dialog-editor">
    <div class="card">
        <h3>–°–æ–æ–±—â–µ–Ω–∏—è (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –¥–ª—è –ø–æ—Ä—è–¥–∫–∞)</h3>
        <div class="msg-list" id="msg-list">
            {% for m in messages %}
            <div class="msg-item" data-id="{{ m.id }}">
                <div class="meta">–û—Ç: {{ m.payload.get('character', '‚Äî') }} ‚Üí –ö–æ–º—É: {{ m.audience }}
                    {% if m.gate_rules and m.gate_rules.get('condition_type') != 'immediate' %}
                    | {{ m.gate_rules.condition_type }}
                    {% endif %}
                </div>
                <div class="text">{{ m.payload.get('text', '')[:120] }}{% if (m.payload.get('text') or '')|length > 120 %}...{% endif %}</div>
                {% if m.payload.get('reply_options') %}<small>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞: {{ m.payload.reply_options|length }}</small>{% endif %}
            </div>
            {% else %}
            <p style="color:var(--admin-muted);">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
            {% endfor %}
        </div>
    </div>
    <div class="card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
        <form method="post" action="/admin/dialogues/{{ thread.id }}/messages" class="form-grid">
            <div>
                <label>–û—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å, —Å @)</label>
                <input type="text" name="character" placeholder="@anna, @bot, @—Ä–µ–∂–∏—Å—Å—ë—Ä...">
            </div>
            <div>
                <label>–ö–æ–º—É –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å</label>
                <select name="audience"><option value="TEAM">–í—Å—è –∫–æ–º–∞–Ω–¥–∞</option><option value="ROLE_A">–†–æ–ª—å A</option><option value="ROLE_B">–†–æ–ª—å B</option></select>
            </div>
            <div>
                <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                <textarea name="text" rows="4" required placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
            </div>
            <div>
                <label>–£—Å–ª–æ–≤–∏–µ –ø–æ–∫–∞–∑–∞</label>
                <select name="condition_type" id="cond-type">
                    <option value="immediate">–°—Ä–∞–∑—É</option>
                    <option value="scheduled">–ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</option>
                    <option value="after_station">–ü–æ—Å–ª–µ –ø–æ—Å–µ—â–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏</option>
                    <option value="after_message">–ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</option>
                </select>
            </div>
            <div id="cond-scheduled" style="display:none;">
                <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                <input type="datetime-local" name="scheduled_at">
            </div>
            <div id="cond-station" style="display:none;">
                <label>–°—Ç–∞–Ω—Ü–∏—è</label>
                <select name="station_id"><option value="">‚Äî</option>{% for s in stations %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}</select>
            </div>
            <div id="cond-message" style="display:none;">
                <label>–ü–æ—Å–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è ID</label>
                <input type="number" name="after_message_id" placeholder="ID —Å–æ–æ–±—â–µ–Ω–∏—è">
            </div>
            <div>
                <label>–ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ (—Å–µ–∫)</label>
                <input type="number" name="delay_after_previous" min="0" value="0" placeholder="0">
            </div>
            <div>
                <label>–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ N —Å–µ–∫ –ø–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è</label>
                <input type="number" name="delete_after_seconds" min="0" value="0" placeholder="0 = –Ω–µ —É–¥–∞–ª—è—Ç—å">
            </div>
            <div>
                <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ (JSON, –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö)</label>
                <textarea name="reply_options" rows="4" placeholder='[{"text": "–°–æ–≥–ª–∞—Å–µ–Ω", "next_message_id": 2, "delay_seconds": 10}, {"text": "–û—Ç–∫–∞–∑", "next_message_id": 3}]'></textarea>
                <small style="color:var(--admin-muted);">next_message_id ‚Äî ID —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞; delay_seconds ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ (—Å–µ–∫)</small>
            </div>
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
    </div>
</div>

<script>
(function() {
    const ct = document.getElementById('cond-type');
    const show = (id, v) => { const e = document.getElementById(id); if (e) e.style.display = v ? 'block' : 'none'; };
    ct.onchange = () => {
        show('cond-scheduled', ct.value === 'scheduled');
        show('cond-station', ct.value === 'after_station');
        show('cond-message', ct.value === 'after_message');
    };
    const list = document.getElementById('msg-list');
    if (list && typeof Sortable !== 'undefined') {
        new Sortable(list, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: async function() {
                const ids = Array.from(list.querySelectorAll('.msg-item')).map(el => el.dataset.id).filter(Boolean);
                await fetch('/admin/dialogues/messages/reorder', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids }) });
            }
        });
    }
})();
</script>
{% endblock %}
