{% extends "admin/base.html" %}
{% block title %}–°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥{% endblock %}
{% block content %}
<style>
    .roster-board {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding-bottom: 16px;
        min-height: 200px;
        overflow: visible;
    }
    .roster-column {
        background: var(--admin-surface);
        border: 2px dashed var(--admin-border);
        border-radius: 10px;
        padding: 12px;
        min-height: 100px;
    }
    .roster-column.roster-unassigned { flex: 1 1 180px; min-width: 180px; }
    .roster-column.roster-team {
        flex: 0 0 130px;
        max-height: 140px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .roster-column.roster-team .player-list {
        flex: 1;
        overflow-y: auto;
        min-height: 44px;
    }
    .roster-column.drag-over { border-color: var(--admin-accent); background: rgba(88,166,255,0.15); }
    .roster-column h3 {
        margin: 0 0 10px;
        font-size: 0.9rem;
        color: var(--admin-muted);
        padding-bottom: 6px;
        border-bottom: 1px solid var(--admin-border);
    }
    .roster-column.roster-team h3 { font-size: 0.85rem; }
    .player-list { min-height: 36px; }
    .player-card {
        background: var(--admin-bg);
        padding: 8px 10px;
        border-radius: 6px;
        margin-bottom: 6px;
        font-size: 0.85rem;
        cursor: grab;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
    }
    .player-card:last-child { margin-bottom: 0; }
    .player-card:hover { border-color: var(--admin-border); }
    .player-card.sortable-ghost { opacity: 0.5; }
    .player-card .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .player-card .role { font-size: 0.7rem; color: var(--admin-muted); flex-shrink: 0; }
    .player-card .remove-btn { background: transparent; border: none; color: var(--admin-muted); cursor: pointer; padding: 2px 4px; font-size: 0.9rem; }
    .player-card .remove-btn:hover { color: #f85149; }
</style>

<h2>–°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥</h2>
<p style="color:var(--admin-muted);">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤ ¬´–ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã¬ª ‚Äî —É–±—Ä–∞—Ç—å –∏–∑ –∫–æ–º–∞–Ω–¥—ã.</p>

<div class="roster-board" id="roster-board">
    <div class="roster-column roster-unassigned" data-team-id="" id="col-unassigned">
        <h3>üö´ –ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã</h3>
        <div class="player-list" data-team-id="">
            {% for item in by_team.get(None, []) %}
            <div class="player-card" data-player-id="{{ item.player.id }}" draggable="true">
                <span class="name">{{ item.name }}</span>
                <span class="role">‚Äî</span>
            </div>
            {% else %}
            <div class="empty-placeholder" style="color:var(--admin-muted);font-size:0.8rem;">–ü—É—Å—Ç–æ</div>
            {% endfor %}
        </div>
    </div>
    {% for team in teams %}
    <div class="roster-column roster-team" data-team-id="{{ team.id }}" id="col-{{ team.id }}">
        <h3>{{ team.name }}</h3>
        <div class="player-list" data-team-id="{{ team.id }}">
            {% for item in by_team.get(team.id, []) %}
            <div class="player-card" data-player-id="{{ item.player.id }}" draggable="true">
                <span class="name">{{ item.name }}</span>
                <span class="role">{{ item.player.role or 'A' }}</span>
            </div>
            {% else %}
            <div class="empty-placeholder" style="color:var(--admin-muted);font-size:0.8rem;">–ü—É—Å—Ç–æ</div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
(function() {
    const csrf = document.querySelector('meta[name="csrf-token"]')?.content || '';

    function getTeamIdFromList(listEl) {
        const col = listEl.closest('.roster-column');
        const tid = col?.dataset.teamId;
        return tid === '' || tid === undefined ? null : (tid ? parseInt(tid) : null);
    }

    const sortableOpts = {
        group: { name: 'players', pull: true, put: true },
        draggable: '.player-card',
        animation: 150,
        ghostClass: 'sortable-ghost',
        emptyInsertThreshold: 25,
        onEnd: async function(evt) {
            const playerId = evt.item?.dataset?.playerId;
            const newList = evt.to;
            const teamId = getTeamIdFromList(newList);
            evt.from.querySelectorAll('.empty-placeholder').forEach(el => el.remove());
            newList.querySelectorAll('.empty-placeholder').forEach(el => el.remove());
            if (!evt.from.querySelector('.player-card')) {
                const ph = document.createElement('div');
                ph.className = 'empty-placeholder';
                ph.style.cssText = 'color:var(--admin-muted);font-size:0.8rem;';
                ph.textContent = '–ü—É—Å—Ç–æ';
                evt.from.appendChild(ph);
            }
            if (!playerId) return;
            const res = await fetch(`/admin/players/${playerId}/team`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ team_id: teamId, role: 'ROLE_A' })
            });
            const data = await res.json();
            if (!data.ok) {
                evt.from.appendChild(evt.item);
                alert(data.error || '–û—à–∏–±–∫–∞');
            }
        }
    };
    Sortable.create(document.getElementById('col-unassigned').querySelector('.player-list'), sortableOpts);

    document.querySelectorAll('.roster-column.roster-team').forEach(col => {
        const list = col.querySelector('.player-list');
        if (!list) return;
        Sortable.create(list, sortableOpts);
    });
})();
</script>
{% endblock %}
