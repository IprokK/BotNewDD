{% extends "admin/base.html" %}
{% block title %}–°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥{% endblock %}
{% block content %}
<style>
    .roster-unassigned-row {
        background: var(--admin-surface);
        border: 2px dashed var(--admin-border);
        border-radius: 10px;
        padding: 12px 16px;
        margin-bottom: 20px;
    }
    .roster-unassigned-row.drag-over { border-color: var(--admin-accent); background: rgba(88,166,255,0.15); }
    .roster-unassigned-row h3 {
        margin: 0 0 10px;
        font-size: 0.9rem;
        color: var(--admin-muted);
    }
    .roster-unassigned-row .player-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 44px;
    }
    .roster-teams-table {
        display: table;
        width: 100%;
        border-collapse: separate;
        border-spacing: 12px;
    }
    .roster-teams-row {
        display: table-row;
    }
    .roster-column {
        display: table-cell;
        vertical-align: top;
        background: var(--admin-surface);
        border: 2px dashed var(--admin-border);
        border-radius: 10px;
        padding: 12px;
        min-width: 130px;
        max-width: 80%;
    }
    .roster-column.roster-team {
        max-height: 140px;
        overflow: hidden;
    }
    .roster-column.roster-team .player-list {
        overflow-y: auto;
        max-height: 100px;
        min-height: 44px;
    }
    .roster-column.drag-over { border-color: var(--admin-accent); background: rgba(88,166,255,0.15); }
    .roster-column h3 {
        margin: 0 0 10px;
        font-size: 0.85rem;
        color: var(--admin-muted);
        padding-bottom: 6px;
        border-bottom: 1px solid var(--admin-border);
    }
    .player-list { min-height: 36px; }
    .roster-teams-table .player-list { display: block; }
    .player-card {
        background: var(--admin-bg);
        padding: 8px 10px;
        border-radius: 6px;
        margin-bottom: 6px;
        font-size: 0.85rem;
        cursor: grab;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
    }
    .roster-unassigned-row .player-card { margin-bottom: 0; }
    .player-card:last-child { margin-bottom: 0; }
    .player-card:hover { border-color: var(--admin-border); }
    .player-card.sortable-ghost { opacity: 0.5; }
    .player-card .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .player-card .role-cell { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
    .player-card .role { font-size: 0.7rem; color: var(--admin-muted); }
    .player-card .role-btn { background: var(--admin-border); border: none; color: var(--admin-text); cursor: pointer; padding: 2px 6px; font-size: 0.7rem; border-radius: 4px; }
    .player-card .role-btn:hover { background: var(--admin-accent); color: #fff; }
    .player-card .remove-btn { background: transparent; border: none; color: var(--admin-muted); cursor: pointer; padding: 2px 4px; font-size: 0.9rem; }
    .player-card .remove-btn:hover { color: #f85149; }
</style>

<h2>–°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥</h2>
<p style="color:var(--admin-muted);">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤ ¬´–ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã¬ª ‚Äî —É–±—Ä–∞—Ç—å –∏–∑ –∫–æ–º–∞–Ω–¥—ã.</p>

<div class="roster-unassigned-row roster-column" data-team-id="" id="col-unassigned">
    <h3>üö´ –ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã</h3>
    <div class="player-list" data-team-id="">
        {% for item in by_team.get(None, []) %}
        <div class="player-card" data-player-id="{{ item.player.id }}" draggable="true">
            <span class="name">{{ item.name }}</span>
            <span class="role">‚Äî</span>
        </div>
        {% else %}
        <div class="empty-placeholder" style="color:var(--admin-muted);font-size:0.8rem;">–ü—É—Å—Ç–æ</div>
        {% endfor %}
    </div>
</div>

<table class="roster-teams-table">
    <tr class="roster-teams-row">
        {% for team in teams %}
        <td class="roster-column roster-team" data-team-id="{{ team.id }}" id="col-{{ team.id }}">
            <h3>{{ team.name }}</h3>
            <div class="player-list" data-team-id="{{ team.id }}">
                {% for item in by_team.get(team.id, []) %}
                <div class="player-card" data-player-id="{{ item.player.id }}" data-team-id="{{ team.id }}" data-role="{{ (item.player.role or 'A')|replace('ROLE_','') }}" draggable="true">
                    <span class="name">{{ item.name }}</span>
                    <span class="role-cell">
                        <span class="role">{{ (item.player.role or 'A')|replace('ROLE_','') }}</span>
                        <button type="button" class="role-btn" title="–°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å">‚Üî</button>
                    </span>
                </div>
                {% else %}
                <div class="empty-placeholder" style="color:var(--admin-muted);font-size:0.8rem;">–ü—É—Å—Ç–æ</div>
                {% endfor %}
            </div>
        </td>
        {% endfor %}
    </tr>
</table>

<script>
(function() {
    const csrf = document.querySelector('meta[name="csrf-token"]')?.content || '';

    function getTeamIdFromList(listEl) {
        const col = listEl.closest('[data-team-id]');
        const tid = col?.dataset.teamId;
        return tid === '' || tid === undefined ? null : (tid ? parseInt(tid) : null);
    }

    const sortableOpts = {
        group: { name: 'players', pull: true, put: true },
        draggable: '.player-card',
        animation: 150,
        ghostClass: 'sortable-ghost',
        emptyInsertThreshold: 25,
        onEnd: async function(evt) {
            const playerId = evt.item?.dataset?.playerId;
            const newList = evt.to;
            const teamId = getTeamIdFromList(newList);
            evt.from.querySelectorAll('.empty-placeholder').forEach(el => el.remove());
            newList.querySelectorAll('.empty-placeholder').forEach(el => el.remove());
            if (!evt.from.querySelector('.player-card')) {
                const ph = document.createElement('div');
                ph.className = 'empty-placeholder';
                ph.style.cssText = 'color:var(--admin-muted);font-size:0.8rem;';
                ph.textContent = '–ü—É—Å—Ç–æ';
                evt.from.appendChild(ph);
            }
            if (!playerId) return;
            const currentRole = evt.item?.dataset?.role || 'A';
            const res = await fetch(`/admin/players/${playerId}/team`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ team_id: teamId, role: 'ROLE_' + currentRole })
            });
            const data = await res.json();
            if (!data.ok) {
                evt.from.appendChild(evt.item);
                alert(data.error || '–û—à–∏–±–∫–∞');
            }
        }
    };
    document.getElementById('col-unassigned').querySelector('.player-list')?.addEventListener('click', handleRoleClick);
    Sortable.create(document.getElementById('col-unassigned').querySelector('.player-list'), sortableOpts);

    async function handleRoleClick(ev) {
        const btn = ev.target.closest('.role-btn');
        if (!btn) return;
        ev.preventDefault();
        ev.stopPropagation();
        const card = btn.closest('.player-card');
        const playerId = card?.dataset?.playerId;
        const teamId = card?.dataset?.teamId;
        const role = card?.dataset?.role || 'A';
        if (!playerId || !teamId) return;
        const newRole = role === 'A' ? 'ROLE_B' : 'ROLE_A';
        const res = await fetch(`/admin/players/${playerId}/team`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team_id: parseInt(teamId), role: newRole })
        });
        const data = await res.json();
        if (data.ok) {
            const newVal = newRole.replace('ROLE_', '');
            card.dataset.role = newVal;
            card.querySelector('.role')?.replaceWith(Object.assign(document.createElement('span'), { className: 'role', textContent: newVal }));
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞');
        }
    }

    document.querySelectorAll('.roster-column.roster-team').forEach(col => {
        const list = col.querySelector('.player-list');
        if (!list) return;
        list.addEventListener('click', handleRoleClick);
        Sortable.create(list, sortableOpts);
    });
})();
</script>
{% endblock %}
