{% extends "admin/base.html" %}
{% block title %}–°—Ç–∞—Ä—Ç—ã –¥–∏–∞–ª–æ–≥–æ–≤{% endblock %}
{% block content %}
<h2>üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞–º–∏ –¥–∏–∞–ª–æ–≥–æ–≤</h2>
<p style="color:var(--admin-muted);">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ, –∫–æ–≥–¥–∞ –¥–∏–∞–ª–æ–≥–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –º–∏–Ω–∏-–∞–ø–ø–µ –∏ –∏–≥—Ä–æ–∫–∞–º –ø—Ä–∏—Ö–æ–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏–ª–∏ –≤—Ä—É—á–Ω—É—é ‚Äî –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥, –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–ª–∏ –≥—Ä—É–ø–ø—ã.</p>

{% if request.query_params.get('triggered') == 'ok' %}
<div style="padding:12px;background:var(--admin-success);color:#fff;border-radius:8px;margin-bottom:16px;">‚úÖ –î–∏–∞–ª–æ–≥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã</div>
{% endif %}
{% if request.query_params.get('err') == 'notfound' %}
<div style="padding:12px;background:var(--admin-warning);color:#fff;border-radius:8px;margin-bottom:16px;">‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
{% endif %}

<div class="card" style="margin-bottom:24px;">
    <h3>–ì—Ä—É–ø–ø—ã –∫–æ–º–∞–Ω–¥</h3>
    <p style="font-size:0.9rem;color:var(--admin-muted);margin-bottom:12px;">–°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É (–Ω–∞–ø—Ä. ¬´–í–æ–ª–Ω–∞ 13:00¬ª) –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã.</p>
    <form method="post" action="/admin/team-groups" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
        <div>
            <label style="display:block;font-size:0.85rem;color:var(--admin-muted);margin-bottom:4px;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" name="name" placeholder="–í–æ–ª–Ω–∞ 13:00" required>
        </div>
        <div style="flex:1;min-width:200px;">
            <label style="display:block;font-size:0.85rem;color:var(--admin-muted);margin-bottom:4px;">ID –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</label>
            <input type="text" name="team_ids" placeholder="1, 2, 3" style="width:100%;">
        </div>
        <button type="submit">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    </form>
    {% if team_groups %}
    <ul style="margin-top:16px;padding-left:20px;">
        {% for g in team_groups %}
        <li><strong>{{ g.name }}</strong> ‚Äî {{ (g.team_ids or [])|length }} –∫–æ–º–∞–Ω–¥</li>
        {% endfor %}
    </ul>
    {% endif %}
</div>

<div class="card" style="margin-bottom:24px;">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ —Å—Ç–∞—Ä—Ç–∞</h3>
    <form method="post" action="/admin/dialogue-start-configs" style="display:grid;gap:12px;max-width:500px;">
        <div>
            <label style="display:block;font-size:0.85rem;color:var(--admin-muted);margin-bottom:4px;">–î–∏–∞–ª–æ–≥</label>
            <select name="thread_id" required>
                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                {% for t in threads %}
                <option value="{{ t.id }}">{{ t.title or t.key }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label style="display:block;font-size:0.85rem;color:var(--admin-muted);margin-bottom:4px;">–°—Ç–∞—Ä—Ç (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –ø—É—Å—Ç–æ = —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é)</label>
            <input type="datetime-local" name="start_at">
            <small style="display:block;margin-top:4px;color:var(--admin-muted);">–í—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ —Å–æ–±—ã—Ç–∏—è (EVENT_TIMEZONE, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ú–æ—Å–∫–≤–∞).</small>
        </div>
        <div>
            <label style="display:block;font-size:0.85rem;color:var(--admin-muted);margin-bottom:4px;">–ö–æ–º—É</label>
            <select name="target_type" id="target-type">
                <option value="all">–í—Å–µ –∫–æ–º–∞–Ω–¥—ã</option>
                <option value="teams">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã</option>
                <option value="group">–ì—Ä—É–ø–ø–∞ –∫–æ–º–∞–Ω–¥</option>
            </select>
        </div>
        <div id="target-teams" style="display:none;">
            <label style="display:block;font-size:0.85rem;color:var(--admin-muted);margin-bottom:4px;">ID –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</label>
            <input type="text" name="target_team_ids" placeholder="1, 2, 3">
        </div>
        <div id="target-group" style="display:none;">
            <label style="display:block;font-size:0.85rem;color:var(--admin-muted);margin-bottom:4px;">–ì—Ä—É–ø–ø–∞</label>
            <select name="target_group_id">
                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                {% for g in team_groups %}
                <option value="{{ g.id }}">{{ g.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label style="display:block;font-size:0.85rem;color:var(--admin-muted);margin-bottom:4px;">–ü–æ—Ä—è–¥–æ–∫ (0, 1, 2...)</label>
            <input type="number" name="order_index" value="0">
        </div>
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
</div>

<div class="card">
    <h3>–ü—Ä–∞–≤–∏–ª–∞ —Å—Ç–∞—Ä—Ç–∞ ({{ configs|length }})</h3>
    <p style="font-size:0.9rem;color:var(--admin-muted);margin-bottom:12px;">–î–∏–∞–ª–æ–≥–∏ –±–µ–∑ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî –≤–∏–¥–Ω—ã –≤—Å–µ–º —Å—Ä–∞–∑—É. –° –ø—Ä–∞–≤–∏–ª–æ–º ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.</p>
    <table style="width:100%;border-collapse:collapse;">
        <thead>
            <tr style="border-bottom:1px solid var(--admin-border);">
                <th style="text-align:left;padding:8px;">–î–∏–∞–ª–æ–≥</th>
                <th style="text-align:left;padding:8px;">–°—Ç–∞—Ä—Ç</th>
                <th style="text-align:left;padding:8px;">–ö–æ–º—É</th>
                <th style="padding:8px;"></th>
            </tr>
        </thead>
        <tbody>
            {% for cfg, thread in configs %}
            <tr style="border-bottom:1px solid var(--admin-border);">
                <td style="padding:8px;">{{ thread.title or thread.key }}</td>
                <td style="padding:8px;">{% if cfg.start_at %}{{ cfg.start_at.strftime('%d.%m.%Y %H:%M') }}{% else %}–≤—Ä—É—á–Ω—É—é{% endif %}</td>
                <td style="padding:8px;">
                    {% if cfg.target_type == 'all' %}–í—Å–µ –∫–æ–º–∞–Ω–¥—ã
                    {% elif cfg.target_type == 'teams' %}{{ (cfg.target_team_ids or [])|length }} –∫–æ–º–∞–Ω–¥
                    {% elif cfg.target_type == 'group' %}–ì—Ä—É–ø–ø–∞
                    {% else %}{{ cfg.target_type }}{% endif %}
                </td>
                <td style="padding:8px;">
                    <form method="post" action="/admin/dialogue-starts/trigger/{{ cfg.id }}" style="display:inline;">
                        <button type="submit" style="padding:4px 10px;font-size:0.85rem;">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                    </form>
                    <form method="post" action="/admin/dialogue-starts/delete-config/{{ cfg.id }}" style="display:inline;margin-left:8px;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ?');">
                        <button type="submit" style="padding:4px 8px;font-size:0.85rem;background:#8b2635;">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="4" style="padding:16px;color:var(--admin-muted);">–ù–µ—Ç –ø—Ä–∞–≤–∏–ª</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<p style="margin-top:16px;font-size:0.85rem;color:var(--admin-muted);">
    –ö–æ–º–∞–Ω–¥—ã: {% for t in teams %}{{ t.id }}=<{{ t.name }}> {% endfor %}
</p>

<script>
(function(){
    const tt = document.getElementById('target-type');
    const divTeams = document.getElementById('target-teams');
    const divGroup = document.getElementById('target-group');
    function show(){
        divTeams.style.display = tt.value === 'teams' ? 'block' : 'none';
        divGroup.style.display = tt.value === 'group' ? 'block' : 'none';
    }
    tt.onchange = show;
    show();
})();
</script>
{% endblock %}
