{% extends "base.html" %}
{% block title %}–°—Ç–∞–Ω—Ü–∏—è {{ station.name }}{% endblock %}
{% block content %}
<div class="card">
    <h2>{{ station.name }}</h2>
    <p id="scanned-team" style="min-height: 60px;"></p>
    <button id="scan-btn" onclick="startScan()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
    <div id="visit-actions" style="display: none; margin-top: 16px;">
        <button id="start-btn" onclick="startVisit()">–ù–∞—á–∞—Ç—å –≤–∏–∑–∏—Ç</button>
        <button id="finish-btn" onclick="showFinishForm()" style="display: none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–∏–∑–∏—Ç</button>
    </div>
</div>

<div id="finish-form" class="card" style="display: none;">
    <h2>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞</h2>
    <form id="finish-frm" onsubmit="finishVisit(event)">
        <label>–û—á–∫–∏</label>
        <input type="number" name="points_awarded" value="0" min="0">
        <label>–û—Ü–µ–Ω–∫–∞ –∫–æ–º–∞–Ω–¥—ã (1-5)</label>
        <input type="number" name="host_rating" min="1" max="5">
        <label>–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea name="host_notes" rows="3"></textarea>
        <button type="submit">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </form>
</div>

<div id="scanner-container" style="margin-top: 16px;"></div>
<div id="result" style="margin-top: 16px;"></div>
{% endblock %}
{% block scripts %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let scannedToken = null;
let scannedTeamId = null;
let qrScanner = null;

async function startScan() {
    const container = document.getElementById('scanner-container');
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '';
    container.innerHTML = '<p>–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</p>';
    if (typeof Html5Qrcode !== 'undefined') {
        container.innerHTML = '<div id="qr-reader"></div>';
        qrScanner = new Html5Qrcode('qr-reader');
        try {
            await qrScanner.start(
                { facingMode: 'environment' },
                { fps: 5, qrbox: { width: 250, height: 250 } },
                (decoded) => {
                    stopScan();
                    submitScan(decoded);
                },
                () => {}
            );
        } catch (e) {
            container.innerHTML = '<p>–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é:</p>' +
                '<input type="text" id="manual-token" placeholder="–¢–æ–∫–µ–Ω –∏–∑ QR">' +
                '<button onclick="submitScan(document.getElementById(\'manual-token\').value)">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>';
        }
    } else {
        container.innerHTML = '<input type="text" id="manual-token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ QR">' +
            '<button onclick="submitScan(document.getElementById(\'manual-token\').value)">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>';
    }
}
function stopScan() {
    if (qrScanner && qrScanner.isScanning) qrScanner.stop();
    document.getElementById('scanner-container').innerHTML = '';
}

async function submitScan(token) {
    const res = await fetch('/station/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Cookie': document.cookie },
        credentials: 'include',
        body: JSON.stringify({ token })
    });
    const data = await res.json();
    if (data.ok) {
        scannedToken = token;
        scannedTeamId = data.team.id;
        document.getElementById('scanned-team').innerHTML = `
            <strong>${data.team.name}</strong><br>
            –û—á–∫–∏: ${data.team.score_total}<br>
            –ò–≥—Ä–æ–∫–æ–≤: ${data.team.players.length}
        `;
        document.getElementById('visit-actions').style.display = 'block';
        if (data.visit_state === 'started') {
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('finish-btn').style.display = 'inline';
        }
    } else {
        document.getElementById('result').innerHTML = '<p style="color: var(--error)">' + (data.error || '–û—à–∏–±–∫–∞') + '</p>';
        document.getElementById('scanned-team').innerHTML = '';
    }
}

async function startVisit() {
    const res = await fetch('/station/visit/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ team_id: scannedTeamId })
    });
    const data = await res.json();
    if (data.ok) {
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('finish-btn').style.display = 'inline';
    }
}

function showFinishForm() {
    document.getElementById('finish-form').style.display = 'block';
}

async function finishVisit(e) {
    e.preventDefault();
    const f = document.getElementById('finish-frm');
    const fd = new FormData(f);
    const res = await fetch('/station/visit/finish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
            team_id: scannedTeamId,
            points_awarded: parseInt(fd.get('points_awarded') || 0),
            host_rating: parseInt(fd.get('host_rating') || 0) || null,
            host_notes: fd.get('host_notes') || null
        })
    });
    const data = await res.json();
    if (data.ok) {
        document.getElementById('scanned-team').innerHTML = '–í–∏–∑–∏—Ç –∑–∞–≤–µ—Ä—à—ë–Ω';
        document.getElementById('visit-actions').style.display = 'none';
        document.getElementById('finish-form').style.display = 'none';
        scannedToken = null;
        scannedTeamId = null;
    }
}
</script>
{% endblock %}
