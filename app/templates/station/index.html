{% extends "station/base_host.html" %}
{% block title %}–°—Ç–∞–Ω—Ü–∏—è{% endblock %}
{% block host_name %}{{ host_name }}{% endblock %}
{% block station_name %}{{ default_station.name if default_station else '–°—Ç–∞–Ω—Ü–∏—è' }}{% endblock %}
{% block head %}
<style>
    .station-select-wrap { display: flex; align-items: center; gap: 8px; }
    .station-select-wrap select { width: auto; min-width: 160px; margin: 0; }
    .points-select-btns { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
    .points-select-btns button { flex: 1; min-width: 50px; padding: 12px; }
</style>
{% endblock %}
{% block content %}
<div class="host-card">
    <h2>–¢–µ–∫—É—â–∞—è —Å—Ç–∞–Ω—Ü–∏—è</h2>
    <div class="station-select-wrap">
        <label style="margin:0;">–°—Ç–∞–Ω—Ü–∏—è:</label>
        <select id="station-select">
            {% for s in stations_data %}
            <option value="{{ s.id }}" {% if default_station and s.id == default_station.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="host-card">
    <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
    <p id="scanned-team" style="min-height: 50px; color: var(--host-muted);">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–æ–º–∞–Ω–¥—ã</p>
    <button id="scan-btn" class="host-btn host-btn-primary" onclick="startScan()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
    <div id="visit-actions" style="display: none; margin-top: 16px; flex-direction: column; gap: 12px;">
        <button id="start-btn" class="host-btn host-btn-success" onclick="startVisit()">‚ñ∂ –ù–∞—á–∞—Ç—å –≤–∏–∑–∏—Ç</button>
        <button id="finish-btn" class="host-btn host-btn-warning" onclick="showFinishForm()" style="display: none;">‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–∏–∑–∏—Ç</button>
    </div>
</div>

<div id="finish-form" class="host-card" style="display: none;">
    <h2>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞</h2>
    <form id="finish-frm" onsubmit="finishVisit(event)">
        <label>–û—á–∫–∏ –∫–æ–º–∞–Ω–¥–µ</label>
        <div id="points-input-free" style="display: none;">
            <input type="number" id="points-free" name="points_awarded" value="0" min="0" max="100" step="0.5" placeholder="0 –∏–ª–∏ 0.5">
        </div>
        <div id="points-input-select" class="points-select-btns" style="display: none;"></div>
        <label>–û—Ü–µ–Ω–∫–∞ –∫–æ–º–∞–Ω–¥—ã (1‚Äì5 –∑–≤—ë–∑–¥)</label>
        <div class="rating-stars" id="rating-stars">
            <button type="button" data-rating="1">‚òÖ</button>
            <button type="button" data-rating="2">‚òÖ</button>
            <button type="button" data-rating="3">‚òÖ</button>
            <button type="button" data-rating="4">‚òÖ</button>
            <button type="button" data-rating="5">‚òÖ</button>
        </div>
        <input type="hidden" name="host_rating" id="host-rating-input" value="">
        <label>–ó–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <textarea name="host_notes" rows="3" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –≤–∏–∑–∏—Ç–µ"></textarea>
        <button type="submit" class="host-btn host-btn-success">–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–∏–∑–∏—Ç</button>
    </form>
</div>

<div id="scanner-container" class="host-card" style="display: none; margin-top: 16px;"></div>
<div id="result" style="margin-top: 16px;"></div>

<script>
const stationsConfig = {{ stations_data|tojson }};
</script>
{% endblock %}
{% block scripts %}
<script>
const stations = stationsConfig.map(s => ({
    id: s.id,
    name: s.name,
    points_mode: (s.config || {}).points_mode || 'free',
    points_options: ((s.config || {}).points_options || '0,1,2,3,5').split(',').map(x => parseFloat(x.trim())).filter(n => !isNaN(n))
}));

let scannedToken = null;
let scannedTeamId = null;
let qrScanner = null;
let selectedRating = 0;

document.getElementById('station-select').addEventListener('change', function() {
    const sel = this.options[this.selectedIndex];
    document.getElementById('station-badge').textContent = sel ? sel.text : '–°—Ç–∞–Ω—Ü–∏—è';
});

function getCurrentStationId() {
    return parseInt(document.getElementById('station-select').value);
}

function getCurrentStation() {
    const id = getCurrentStationId();
    return stations.find(s => s.id === id) || stations[0];
}

async function startScan() {
    const container = document.getElementById('scanner-container');
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '';
    container.style.display = 'block';
    container.innerHTML = '<p style="text-align:center;padding:20px;">–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</p>';
    if (typeof Html5Qrcode !== 'undefined') {
        container.innerHTML = '<div id="qr-reader"></div>';
        qrScanner = new Html5Qrcode('qr-reader');
        try {
            await qrScanner.start(
                { facingMode: 'environment' },
                { fps: 8, qrbox: { width: 260, height: 260 } },
                (decoded) => {
                    stopScan();
                    submitScan(decoded);
                },
                () => {}
            );
        } catch (e) {
            container.innerHTML = '<p style="margin-bottom:12px;">–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é:</p>' +
                '<input type="text" id="manual-token" placeholder="–¢–æ–∫–µ–Ω –∏–∑ QR" style="margin-bottom:12px;">' +
                '<button class="host-btn host-btn-primary" onclick="submitScan(document.getElementById(\'manual-token\').value)">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>';
        }
    } else {
        container.innerHTML = '<input type="text" id="manual-token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ QR">' +
            '<button class="host-btn host-btn-primary" onclick="submitScan(document.getElementById(\'manual-token\').value)">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>';
    }
}

function stopScan() {
    if (qrScanner && qrScanner.isScanning) qrScanner.stop();
    document.getElementById('scanner-container').style.display = 'none';
    document.getElementById('scanner-container').innerHTML = '';
}

async function submitScan(token) {
    const res = await fetch('/station/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ token, station_id: getCurrentStationId() })
    });
    const data = await res.json();
    if (data.ok) {
        scannedToken = token;
        scannedTeamId = data.team.id;
        document.getElementById('scanned-team').innerHTML = '<strong style="color:var(--host-text);">' + data.team.name + '</strong><br>–û—á–∫–∏: ' + data.team.score_total + '<br>–ò–≥—Ä–æ–∫–æ–≤: ' + data.team.players.length;
        document.getElementById('visit-actions').style.display = 'flex';
        if (data.visit_state === 'started') {
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('finish-btn').style.display = 'flex';
        } else {
            document.getElementById('start-btn').style.display = 'flex';
            document.getElementById('finish-btn').style.display = 'none';
        }
    } else {
        document.getElementById('result').innerHTML = '<p style="color: var(--host-danger);">' + (data.error || '–û—à–∏–±–∫–∞') + '</p>';
        document.getElementById('scanned-team').innerHTML = '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–æ–º–∞–Ω–¥—ã';
    }
}

async function startVisit() {
    const res = await fetch('/station/visit/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ team_id: scannedTeamId, station_id: getCurrentStationId() })
    });
    const data = await res.json();
    if (data.ok) {
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('finish-btn').style.display = 'flex';
    }
}

function showFinishForm() {
    document.getElementById('finish-form').style.display = 'block';
    selectedRating = 0;
    document.querySelectorAll('.rating-stars button').forEach(b => b.classList.remove('active'));
    document.getElementById('host-rating-input').value = '';

    const st = getCurrentStation();
    const freeDiv = document.getElementById('points-input-free');
    const selectDiv = document.getElementById('points-input-select');

    if (st.points_mode === 'select' && st.points_options.length > 0) {
        freeDiv.style.display = 'none';
        selectDiv.style.display = 'flex';
        selectDiv.innerHTML = '';
        const defVal = st.points_options[0];
        document.getElementById('points-free').value = defVal;
        st.points_options.forEach(v => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'host-btn host-btn-ghost points-opt-btn' + (v === defVal ? ' host-btn-primary' : '');
            btn.textContent = v;
            btn.dataset.points = v;
            btn.onclick = () => {
                document.querySelectorAll('.points-opt-btn').forEach(b => { b.classList.remove('host-btn-primary'); b.classList.add('host-btn-ghost'); });
                btn.classList.add('host-btn-primary');
                btn.classList.remove('host-btn-ghost');
                document.getElementById('points-free').value = v;
            };
            selectDiv.appendChild(btn);
        });
    } else {
        freeDiv.style.display = 'block';
        selectDiv.style.display = 'none';
        document.getElementById('points-free').value = 0;
    }
}

document.querySelectorAll('.rating-stars button').forEach(btn => {
    btn.addEventListener('click', function() {
        selectedRating = parseInt(this.dataset.rating);
        document.querySelectorAll('.rating-stars button').forEach(b => {
            b.classList.toggle('active', parseInt(b.dataset.rating) <= selectedRating);
        });
        document.getElementById('host-rating-input').value = selectedRating;
    });
});

async function finishVisit(e) {
    e.preventDefault();
    const f = document.getElementById('finish-frm');
    const fd = new FormData(f);
    const ptsInput = document.getElementById('points-free');
    const ptsVal = ptsInput ? parseFloat(ptsInput.value) || 0 : 0;
    const res = await fetch('/station/visit/finish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
            team_id: scannedTeamId,
            station_id: getCurrentStationId(),
            points_awarded: ptsVal,
            host_rating: parseInt(fd.get('host_rating') || 0) || null,
            host_notes: fd.get('host_notes') || null
        })
    });
    const data = await res.json();
    if (data.ok) {
        document.getElementById('scanned-team').innerHTML = '<span style="color:var(--host-success);">‚úì –í–∏–∑–∏—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</span>';
        document.getElementById('visit-actions').style.display = 'none';
        document.getElementById('finish-form').style.display = 'none';
        scannedToken = null;
        scannedTeamId = null;
    }
}
</script>
{% endblock %}
